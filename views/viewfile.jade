extends layout

block stylesheets
  link(rel="stylesheet", href="http://blmarket.net/~blmarket/jsdifflib/diffview.css")

block contents
  div
    #commitsha
    #diffOutput
    #comments(ng-controller="CommentsCtrl")
      {{comments}}
      form(ng-submit="submit()")
        textarea
        input(type="submit")asdf

block scripts
  script(src="http://blmarket.net/~blmarket/jsdifflib/diffview.js")
  script(src="http://blmarket.net/~blmarket/jsdifflib/difflib.js")
  script(type="text/javascript")
    var data = !{data};
    var index = 0;
    var target = $('#diffOutput');
      
    function CommentsCtrl($scope, $http) {
      function update(commit) {
        $scope.commit = commit;
        $http.jsonp(
          "https://api.github.com/repos/#{repo.owner}/#{repo.name}/commits/"+commit+"/comments?callback=JSON_CALLBACK"
        ).success(function(data, status) {
          $scope.comments = data.data;
        });
      }

      function submit() {
        if(!($scope.commit)) return;
        $http.post(
          "https://api.github.com/repos/#{repo.owner}/#{repo.name}/commits/"+$scope.commit+"/comments",
          {
            access_key: "#{access_key}",
            body: "nice commit!"
          }
        ).success(function(data, status) {
        });
      }

      $scope.comments = '';
      $scope.commit = '';
      $scope.update = update;
      $scope.submit = submit;
    }

    function update() {
      var left = index - 1; if(left < 0) left = 0;
      var base = difflib.stringAsLines(data[left].code);
      var other = difflib.stringAsLines(data[index].code);
      
      var sm = new difflib.SequenceMatcher(base, other);
      target.empty();
      target.append(diffview.buildView({
        baseTextLines: base,
        newTextLines: other,
        opcodes: sm.get_opcodes(),
        baseTextName: 'Older Version',
        newTextName: 'Newer Version',
        contextSize: null,
        viewType: 1
      }));

      $('#commitsha').text(data[index].commit);
      angular.element(document.getElementById('comments')).scope().$apply(function(scope) {
        scope.update(data[index].commit);
      });
    }
    
    $(document).ready(update);  
    $(window).keyup(function(ev) {
      if(ev.keyCode == 37) {
        index--; if(index < 0) index = 0; update();
      } else if(ev.keyCode == 39) {
        index++; if(index >= data.length) index = data.length - 1; update();
      }
    });

